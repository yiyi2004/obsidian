## 01 Agent 通过 Rpc 定时同步 Logjob

- main 中

```go
		{
			// logJob和server直接同步的
			g.Add(func() error {
				err := logjob.TickerLogJobSync(rpcCli, ctxAll, logJobsyncChan, localConfigJobs, metricsMap, common.GetHostName())
				if err != nil {
					level.Error(logger).Log("msg", "PointCounterManager.SetMetricsManager.error", "err", err)
					return err
				}
				return err

			}, func(err error) {
				cancelAll()
			},
			)
		}
```

- 处理同步的结果的，位置 D:\go_path\src\open-devops\src\modules\agent\logjob\log_sync.go

```go
package logjob

import (
	"context"
	"encoding/json"
	"github.com/prometheus/client_golang/prometheus"
	"github.com/toolkits/pkg/logger"
	"open-devops/src/models"
	"open-devops/src/modules/agent/config"
	"open-devops/src/modules/agent/rpc"
	"time"
)

func TickerLogJobSync(cli *rpc.RpcCli, ctx context.Context, logJobsyncChan chan []*LogJob, localConfigJobs []*LogJob, metricsMap map[string]*prometheus.GaugeVec, hostName string) error {
	ticker := time.NewTicker(5 * time.Second)
	doLogJobSync(cli, logJobsyncChan, localConfigJobs, metricsMap, hostName)
	defer ticker.Stop()
	for {
		select {
		case <-ctx.Done():
			logger.Infof("TickerLogJobSync.receive_quit_signal_and_quit")
			return nil
		case <-ticker.C:
			doLogJobSync(cli, logJobsyncChan, localConfigJobs, metricsMap, hostName)
		}
	}

}

func doLogJobSync(cli *rpc.RpcCli, logJobsyncChan chan []*LogJob, localConfigJobs []*LogJob, metricsMap map[string]*prometheus.GaugeVec, hostName string) {

	res := cli.LogJobSync(hostName)
	ls := []*models.LogStrategy{}
	//

	for _, i := range res {
		i := i
		m := map[string]string{}
		json.Unmarshal([]byte(i.TagJson), &m)
		i.Tags = m
		labels := []string{}
		for k := range i.Tags {
			labels = append(labels, k)
		}
		me := prometheus.NewGaugeVec(prometheus.GaugeOpts{
			Name: i.MetricName,
			Help: i.MetricHelp,
		}, labels)
		// 为了动态注册，防止重复注册，用map
		if _, loaded := metricsMap[i.MetricName]; !loaded {
			prometheus.MustRegister(me)
			metricsMap[i.MetricName] = me

		}

		ls = append(ls, i)

		logger.Infof("[doLogJobSync.rpc.res][num:%d][res:%+v]i.Tags:%+v", len(res), i, i.Tags)
	}

	newLs := config.SetLogRegs(ls)
	for _, i := range newLs {
		j := &LogJob{Stra: i}
		localConfigJobs = append(localConfigJobs, j)

	}

	logJobsyncChan <- localConfigJobs
}

```

- rpc 中添加同步的方法，位置 D:\go_path\src\open-devops\src\modules\agent\rpc\log_job.go

```go
package rpc

import (
	"github.com/go-kit/log/level"
	"github.com/toolkits/pkg/logger"
	"open-devops/src/models"
)

func (r *RpcCli) LogJobSync(hostname string) []*models.LogStrategy {
	var res []*models.LogStrategy
	err := r.GetCli()
	if err != nil {
		level.Error(r.logger).Log("msg", "get cli error", "serverAddr", r.ServerAddr, "err", err)
		return nil
	}
	err = r.Cli.Call("Server.LogJobSync", hostname, &res)
	if err != nil {
		r.CloseCli()
		level.Error(r.logger).Log("msg", "Server.LogJobSync.error", "serverAddr", r.ServerAddr, "err", err)
		return nil
	}

	logger.Infof("LogJobSync.res:%+v", res)
	return res
}

```

## 02 Server 添加 Logjob 同步的 Rpc 方法

- 位置 D:\go_path\src\open-devops\src\modules\server\rpc\log_job_sync.go

```go
package rpc

import (
	"github.com/toolkits/pkg/logger"
	"open-devops/src/models"
)

// input = agent.hostName
func (*Server) LogJobSync(input string, output *[]*models.LogStrategy) error {
	ljs, _ := models.LogJobGets("id>0")

	*output = ljs
	logger.Infof("LogJobSync.call.receive ljs :%v %v %v", ljs, input, output)
	return nil

}

```

- server 端新建这个表

```sql

drop table log_job;


CREATE TABLE `log_job` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `metric_name` varchar(200) DEFAULT NULL,
  `metric_help` varchar(200) DEFAULT NULL,
  `file_path` varchar(200) DEFAULT NULL,
  `pattern` varchar(200) DEFAULT NULL,
  `func` varchar(20) DEFAULT NULL,
  `creator` varchar(100) DEFAULT NULL,
  `tag_json` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_unique_key` (`metric_name`,`tag_json`) USING BTREE COMMENT '唯一索引'
) ENGINE=InnoDB  DEFAULT CHARSET=utf8;



```

## 03 Server 端添加 Logjob 的 Http 路由和校验

- D:\go_path\src\open-devops\src\modules\server\web\route_log_job.go 添加 logjob 相关的路由
- ```go
  package web

  import (
  	"github.com/gin-gonic/gin"
  	"open-devops/src/common"
  	"open-devops/src/models"
  )

  func LogJobAdd(c *gin.Context) {

  	var input models.LogStrategy
  	if err := c.BindJSON(&input); err != nil {
  		common.JSONR(c, 400, err)
  		return
  	}
  	id, err := input.AddOne()
  	if err != nil {
  		common.JSONR(c, 500, err)
  		return
  	}
  	common.JSONR(c, 200, id)
  }

  func LogJobGets(c *gin.Context) {

  	ljs, err := models.LogJobGets("id>0")
  	if err != nil {
  		common.JSONR(c, 500, err)
  		return
  	}

  	common.JSONR(c, 200, ljs)
  }

  ```

## 04 测试 Agent 本地的 Yaml 配置

- 编译运行，查看 agent 的 http://192.168.3.200:8087/metrics
- ```
  # HELP log_containerd_total /var/log/messages 中的 containerd日志 total
  # TYPE log_containerd_total gauge
  log_containerd_total{level="info"} 220
  # HELP ngx_acc_code nginx code avg
  # TYPE ngx_acc_code gauge
  ngx_acc_code 2241.6
  ```
- 还可以手动 echo 日志到 nginx 日志文件中
- ```
  [root@prome-master01 open-devops]# echo '::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=10000] 0 "-" "curl/7.29.0" "-"' >> /var/log/nginx/access.log
  [root@prome-master01 open-devops]# cat /var/log/nginx/access.log
  ::1 - - [27/Nov/2021:18:01:41 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:53 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:54 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:54 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:55 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:56 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:56 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:01:57 +0800] "GET / HTTP/1.1" [code=200] 4833 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:13 +0800] "GET /wdwd HTTP/1.1" [code=404] 3650 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:19 +0800] "GET /wdwd HTTP/1.1" [code=404] 3650 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:23 +0800] "GET /wdwd HTTP/1.1" [code=404] 3650 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:25 +0800] "HEAD /wdwd HTTP/1.1" [code=404] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:27 +0800] "HEAD /wdwd HTTP/1.1" [code=404] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:28 +0800] "HEAD /wdwd HTTP/1.1" [code=404] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=404] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=404] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=10000] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=10000] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=10000] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=10000] 0 "-" "curl/7.29.0" "-"
  ::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=10000] 0 "-" "curl/7.29.0" "-"

  ```

## 05 通过 Http 新增一条日志监控，server 下发给 agent，agent 采集

- 首先是 python 调用 http 新增一条 logjob
- ```python
  def log_job_add():
      """


      CREATE TABLE `log_job` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `metric_name` varchar(200) DEFAULT NULL,
    `metric_help` varchar(200) DEFAULT NULL,
    `file_path` varchar(200) DEFAULT NULL,
    `pattern` varchar(200) DEFAULT NULL,
    `func` varchar(20) DEFAULT NULL,
    `creator` varchar(100) DEFAULT NULL,
    `tag_json` varchar(200) DEFAULT NULL,
    PRIMARY KEY (`id`),
      :return:

        - metric_name: log_containerd_total
      metric_help: /var/log/messages 中的 containerd日志 total
      file_path: /var/log/messages
      pattern:  ".*containerd.*"
      func: cnt
      tags:
        level: ".*level=(.*?) .*"
      """
      tag = {
          "level": '''.*level=(.*?) .*'''
      }
      data = {
          "metric_name": "log_nginx_code_max_1",
          "metric_help": "log_abc",
          "file_path": "/var/log/nginx/access.log",
          "pattern": ".*\[code=(.*?)\].*",
          "func": "max",
          "creator": "xiaoyi",
          # "tag_json": json.dumps(tag),

      }
      print(data)
      uri = 'http://192.168.3.200:8082/api/v1/log-job'
      res = requests.post(uri, json=data, headers=JSON_H)
      print(curlify.to_curl(res.request))
      print(res.status_code)
      print(res.text)

  ```
- 在 mysql 中查询 logjob 表
- ```
  mysql> select * from log_job;
  +----+----------------------+-------------+---------------------------+--------------------+------+---------+----------+
  | id | metric_name          | metric_help | file_path                 | pattern            | func | creator | tag_json |
  +----+----------------------+-------------+---------------------------+--------------------+------+---------+----------+
  |  1 | log_nginx_code_max_1 | log_abc     | /var/log/nginx/access.log | .*\[code=(.*?)\].* | max  | xiaoyi  |          |
  +----+----------------------+-------------+---------------------------+--------------------+------+---------+----------+
  1 row in set (0.00 sec)

  mysql> 

  ```
- 手动往 nginx 日志中塞入数据
- ```shell
  [root@prome-master01 ~]# echo '::1 - - [27/Nov/2021:18:02:29 +0800] "HEAD /wdwd HTTP/1.1" [code=99999] 0 "-" "curl/7.29.0" "-"' >> /var/log/nginx/access.log
  [root@prome-master01 ~]# 

  ```
- 观察日志，也可以观察 agent 的 metrics 结果
- ```shell
  # HELP log_nginx_code_max_1 log_abc
  # TYPE log_nginx_code_max_1 gauge
  log_nginx_code_max_1 99999
  ```
