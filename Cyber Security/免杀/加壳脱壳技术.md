## 基础概念及工具

一 什么是壳：  
软件的壳分为加密壳、压缩壳、伪装壳、多层壳等类，目的都是为了隐藏程序真正的 OEP（入口点，防止被破解）。   

二 病毒加壳：  
所谓加壳，是一种通过一系列数学运算，将可执行程序文件或动态链接库文件的编码进行改变（目前还有一些加壳软件可以压缩、加密驱动程序），以达到缩小文件体积或加密程序编码的目的。当被加壳的程序运行时，外壳程序先被执行，然后由这个外壳程序负责将用户原有的程序在内存中解压缩，并把控制权交还给脱壳后的真正程序。一切操作自动完成，用户不知道也无需知道壳程序是如何运行的。一般情况下，加壳程序和未加壳程序的运行结果是一样的。   

既然加壳后的病毒不易被发现，那么如何判断一个可执行文件是否被加了壳呢？   

有一个简单的方法（对中文软件效果较明显）。用记事本打开一个可执行文件，如果能看到软件的提示信息则一般是未加壳的，如果完全是乱码，则多半是被加壳的。我们还可以使用一款叫做 Fileinfo 的工具来查看文件具体加的是什么壳。目前，较常见到的壳有 **“UPX”、“ASPack”、“PePack”、“PECompact”、“UPack”、“NsPack”、“免疫 007”、“木马彩衣”**等等。   

病毒加壳的原理很简单，现在黑客营中提供的多数病毒中，很多都是经过处理的，而这些处理就是所谓的加壳。我们知道当一个普通的 EXE 程序生成好后，很轻松的就可以利用诸如资源工具和反汇编工具对它进行修改，但如果程序员给 EXE 程序加一个壳的话，那么至少这个加了壳的 EXE 程序就不是那么好修改了，如果想修改就必须先脱壳。病毒加壳后也是同样的道理，我们也必须先为病毒脱壳。

三 脱壳方法：  
常用脱壳工具有：   

1. 文件分析工具（侦测壳的类型）：Fi，GetTyp，peid，pe-scan,   
2. OEP 入口查找工具：SoftICE，TRW，ollydbg，loader，peid   
3. dump 工具：IceDump，TRW，PEditor，ProcDump32，LordPE   
4. PE 文件编辑工具 PEditor，ProcDump32，LordPE   
5. 重建 Import Table 工具：ImportREC，ReVirgin   
6. ASProtect 脱壳专用工具：Caspr（ASPr V1.1-V1.2 有效），Rad（只对 ASPr V1.1 有效），loader，peid   
	1. Aspack： 用的最多，但只要用 UNASPACK 或 PEDUMP32 脱壳就行了   
	2. ASProtect+aspack：次之，国外的软件多用它加壳，脱壳时需要用到 SOFTICE+ICEDUMP，需要一定的专业知识，但最新版现在暂时没有办法。   
	3. Upx： 可以用 UPX 本身来脱壳，但要注意版本是否一致，用 -D 参数   
	4. Armadill： 可以用 SOFTICE+ICEDUMP 脱壳，比较烦   
	5. Dbpe： 国内比较好的加密软件，新版本暂时不能脱，但可以破解   
	6. NeoLite： 可以用自己来脱壳   
	7. Pcguard： 可以用 SOFTICE+ICEDUMP+FROGICE 来脱壳   
	8. Pecompat： 用 SOFTICE 配合 PEDUMP32 来脱壳，但不要专业知识   
	9. Petite： 有一部分的老版本可以用 PEDUMP32 直接脱壳，新版本脱壳时需要用到 SOFTICE+ICEDUMP，需要一定的专业知识。   
	10. WWpack32： 和 PECOMPACT 一样其实有一部分的老版本可以用 PEDUMP32 直接脱壳，不过有时候资源无法修改，也就无法汉化，所以最好还是用 SOFTICE 配合 PEDUMP32 脱壳   

## 几种常见的壳

![[Pasted image 20230217195016.png]]

- 代码放到网络上
- VMP 加壳，虚拟机技术，汇编代码提交到虚拟机上执行，只能看到虚拟机上的变化，看不到实际的执行过程。**虚拟机开发**
- UPX 压缩的壳 ---> 提供压缩的算法，改变代码的特征，免杀，刚入门的时候。
	- 360 对于主动防御的是比较有效的。

### SE

- 当代码加载到内存中的时候，代码段是会发生改变的。

### VMP

### UPX

## 脱壳

![[Pasted image 20230217195719.png]]

- 看开始的地方
- 壳的检测工具

## Reference

- [病毒加壳技术与脱壳技术_B_H_L的博客-CSDN博客](https://blog.csdn.net/B_H_L/article/details/12772721?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167659979016800184155324%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=167659979016800184155324&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-12772721-null-null.142^v73^wechat_v2,201^v4^add_ask,239^v2^insert_chatgpt&utm_term=%E7%97%85%E6%AF%92%E5%8A%A0%E5%A3%B3%E6%8A%80%E6%9C%AF&spm=1018.2226.3001.4187)
