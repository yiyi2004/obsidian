## 多实例部署的 Session 问题

答案是 Gin 本身提供了很多的实现，包括:

- cookie：基于内存的实现
- gorm：基于 GORM 的实现
- memcached：基于 Memcached 的实现
- memstore：基于内存的实现
- mongo：基于 MongoDB 的实现
- postgres：基于 PostgreSQL 的实现
- redis：基于 Redis 的实现
- tester：用于测试的实现  

基于 Redis 实现

![[Snipaste/Pasted image 20240115162229.png]]

- **Authentication**：是指身份认证。
- **Encryption**：是指数据加密。  
- 授权：权限控制

这两者再加上授权（权限控制），就是信息安全的三个核心概念。

提供功能的时候需要考虑，**是否需要不同的实现**——面向接口编程

## 刷新 Session 的过期时间

> 举个例子：假如你设置为 10 分钟，那么用户登录了 9:59 秒之后，还能访问网站，结果过了两秒，他就被要求重新登录。

**需要在用户使用网站的时候刷新过期时间**，不然会被要求重新登录网站，体验不好。

几种策略：  

1. 用户每次访问，我都刷新。
	1. 性能差，对 Redis 之类的影响很大。
2. 快要过期了我再刷新，比如说 10 分钟过期。当用户第 9 分钟访问过来的时候，我就刷新。
	1. 万一我在第 9 分钟以后都没再访问过呢？——正好是 8.59 或者 10.01 访问呢？
3. 固定间隔时间刷新，比如说每分钟内第一次访问我都刷新。
4. 使用长短 token。这个我们在后面接入微信登录的时候再深入讨论。

在 Middleware 中进行刷新，登录校验的时候进行刷新。  

登录状态保持多久比较好？  
也就是，一次登录之后，要隔多久才需要继续登录？ 答案是取决于你的**产品经理**，也取决于你系统其它方面的安全措施。 简单来说，就是如果你有别的验证用户身份的机制，那么你就可以让用户长时间不需要登录。

## JWT

组成：  

- Header：头部，JWT 的**元数据**，也就是描述这个 token 本身的数据，一个 JSON 对象。
- Payload：负载，**数据内容**，一个 JSON 对象。
- Signature：签名，**根据 header 和 token 生成**。

```shell
go get github.com/golang-jwt/jwt/v5
```

登录过程中使用 JWT 的两步：

1. JWT 加密和解密数据
2. 登录校验

JWT 的基本使用方法

![[Snipaste/Pasted image 20240115163432.png]]

一定要进行跨域的设置

![[Snipaste/Pasted image 20240115163521.png]]

![[Snipaste/Pasted image 20240115163659.png]]

前端每次访问，携带 token  
![[Snipaste/Pasted image 20240115163738.png]]

JWT Token 的总结  

![[Snipaste/Pasted image 20240115164402.png]]

和 Session 比起来，优点：

- 不依赖于第三方存储。
- 适合在分布式环境下使用。
- **提高性能**（因为没有 Redis 访问之类的）。  
缺点：
- 对加密依赖非常大，比 Session 容易泄密。
- **最好不要在 JWT 里面放置敏感信息。**

如何混用 session 和 JWT

- 前面 JWT 限制了我们不能使用敏感数据，那么你真有类似需求的时候，就可以考虑将数据放在 “Session”里面。  
- 基本的思路就是：你在 JWT 里面存储你的 userId，然后用 userId 来组成 key，比如说 **user.info:123** 这 种 key，然后用这个 key 去 **Redis** 里面取数据，也可以考虑使用本地缓存数据。

## 初步保护系统

- 正常用户会不会搞崩你的系统？
- 如果有人攻击你的系统，你能撑住吗？  

对于中小型公司来说，第一条不会是问题。对于大公司来说，就要两条都考虑。  

冷静下来

**你今天已经很棒了**。
