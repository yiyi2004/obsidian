## 01 编译

```shell

go build -o server src/modules/server/server.go
go build -o agent src/modules/agent/agent.go
```

## 02 运行

- 我们之前通过 python 脚本添加过 1 个 ss -tnlp 的任务

```shell
mysql> select * from task_meta\G
*************************** 1. row ***************************
       id: 1
    title: test01
  account: root
  timeout: 5
hosts_raw: ["192.168.3.200", "192.168.3.201"]
   script: #!/bin/bash
ss -ntlp
     args: 
  creator: xiaoyi
  created: 2021-11-25 19:44:01
     done: 1

```

- 运行之后可以看到 agent 目录下面有 meta 目录。并且有任务 id 为 1 的任务结果

```shell
[root@prome-master01 1]# pwd
/opt/app/open-devops/open-devops/meta/1
[root@prome-master01 1]# ll
总用量 20
-rw-r--r-- 1 root root    7 11月 25 19:43 0.done
-rw-r--r-- 1 root root    4 11月 25 19:43 account
-rw-r--r-- 1 root root    0 11月 25 19:43 args
-rwxr-xr-x 1 root root   20 11月 25 19:43 script
-rw-r--r-- 1 root root    0 11月 25 19:43 stderr
-rw-r--r-- 1 root root 6791 11月 25 19:43 stdout



[root@prome-master01 1]# cat 0.done 
success[root@prome-master01 1]# 
[root@prome-master01 1]# cat script 
#!/bin/bash
ss -ntlp[root@prome-master01 1]# 
[root@prome-master01 1]# 
[root@prome-master01 1]# 
[root@prome-master01 1]# cat stdout 
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port        
LISTEN     0      128          *:8085                     *:*                   users:(("kube-proxy",pid=3308,fd=21))
LISTEN     0      128          *:22                       *:*                   users:(("sshd",pid=985,fd=3))
LISTEN     0      128          *:32567                    *:*                   users:(("kube-proxy",pid=3308,fd=15))

```

## 03 测试从 Python 脚本添加一个新的任务

- python 脚本

```python
def task_add():
    """

CREATE TABLE `task_meta`
(
    `id`        bigint unsigned NOT NULL AUTO_INCREMENT,
    `title`     varchar(255)    not null default '' COMMENT '标题',
    `account`   varchar(64)     not null COMMENT '脚本执行账号',
    `timeout`   int unsigned    not null default 0  COMMENT '执行超时',
    `hosts_raw` varchar(4096)   not null  COMMENT '执行机器的ip列表json',
    `script`    text            not null COMMENT '执行的脚本',
    `args`      varchar(512)    not null default '' COMMENT '执行的脚本的参数',
    `creator`   varchar(64)     not null default '' COMMENT '创建者',
    `created`   timestamp       not null COMMENT '创建时间',
    `done`      int unsigned    not null COMMENT '任务结束与否的标志位=0未结束，=1结束',
    PRIMARY KEY (`id`),
    KEY (`created`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
    """

    data = {
        "script": '''ping -c 4 baidu.com''',
        "account": "root",
        "title": "test02",
        "timeout": 5,
        "hosts": json.dumps(["192.168.3.200","192.168.3.201"]),
        "creator": "xiaoyi",
        # "created": 123,
        # "done": "0",
        # "tag_json": json.dumps(tag),

    }
    print(data)
    uri = 'http://192.168.3.200:8082/api/v1/task'
    # uri = 'http://localhost:8082/api/v1/task'
    res = requests.post(uri, json=data, headers=JSON_H)
    print(curlify.to_curl(res.request))
    print(res.status_code)
    print(res.text)
```

- 然后观察 meta 目录下发现 id 为 2 的目录

```shell
[root@prome-master01 2]# pwd
/opt/app/open-devops/open-devops/meta/2
[root@prome-master01 2]# ll
总用量 16
-rw-r--r-- 1 root root   7 11月 25 19:48 0.done
-rw-r--r-- 1 root root   4 11月 25 19:47 account
-rw-r--r-- 1 root root   0 11月 25 19:47 args
-rwxr-xr-x 1 root root  19 11月 25 19:47 script
-rw-r--r-- 1 root root   0 11月 25 19:48 stderr
-rw-r--r-- 1 root root 514 11月 25 19:48 stdout
[root@prome-master01 2]# cat stdout 
PING baidu.com (220.181.38.251) 56(84) bytes of data.
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=1 ttl=50 time=9.96 ms
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=2 ttl=50 time=8.26 ms
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=3 ttl=50 time=8.22 ms
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=4 ttl=50 time=7.76 ms

--- baidu.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 7.761/8.553/9.967/0.847 ms

```

## 04 观察 Mysql 中的 task_result 表

- 查询

```shell
*************************** 2. row ***************************
     id: 2
task_id: 2
   host: 192.168.3.200
 status: success
 stdout: PING baidu.com (220.181.38.251) 56(84) bytes of data.
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=1 ttl=50 time=9.96 ms
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=2 ttl=50 time=8.26 ms
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=3 ttl=50 time=8.22 ms
64 bytes from 220.181.38.251 (220.181.38.251): icmp_seq=4 ttl=50 time=7.76 ms

--- baidu.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 7.761/8.553/9.967/0.847 ms

 stderr: 
2 rows in set (0.00 sec)

```

## 05 演示 Kill

- 添加一个长时间运行的任务，ping baidu.com ,先运行一段时间后再置为 kill
- ```python

  def task_add():
      """

  CREATE TABLE `task_meta`
  (
      `id`        bigint unsigned NOT NULL AUTO_INCREMENT,
      `title`     varchar(255)    not null default '' COMMENT '标题',
      `account`   varchar(64)     not null COMMENT '脚本执行账号',
      `timeout`   int unsigned    not null default 0  COMMENT '执行超时',
      `hosts_raw` varchar(4096)   not null  COMMENT '执行机器的ip列表json',
      `script`    text            not null COMMENT '执行的脚本',
      `args`      varchar(512)    not null default '' COMMENT '执行的脚本的参数',
      `creator`   varchar(64)     not null default '' COMMENT '创建者',
      `created`   timestamp       not null COMMENT '创建时间',
      `done`      int unsigned    not null COMMENT '任务结束与否的标志位=0未结束，=1结束',
      PRIMARY KEY (`id`),
      KEY (`created`)
  ) ENGINE = InnoDB
    DEFAULT CHARSET = utf8;
      """

      data = {
          "script": '''ping  baidu.com''',
          # "script": '''#!/bin/bash\nss -ntlp''',
          "account": "root",
          "title": "test03",
          "timeout": 600,
          "hosts": json.dumps(["192.168.3.200","192.168.3.201"]),
          "creator": "xiaoyi",
          # "action": "kill",
          # "created": 123,
          # "done": "0",
          # "tag_json": json.dumps(tag),

      }
      print(data)
      uri = 'http://192.168.3.200:8082/api/v1/task'
      # uri = 'http://localhost:8082/api/v1/task'
      res = requests.post(uri, json=data, headers=JSON_H)
      print(curlify.to_curl(res.request))
      print(res.status_code)
      print(res.text)

  ```
- 先让这个任务启动起来，然后查看 ping 任务的 ppid
- ```bash
  [root@prome-master01 ~]# ps -ef |grep ping 
  root      57314  57313  0 12:01 pts/1    00:00:00 ping baidu.com
  root      57595  57576  0 12:01 pts/3    00:00:00 grep --color=auto ping
  [root@prome-master01 ~]# ps -ef |
  > g^C
  [root@prome-master01 ~]# ps -ef |grep 57313
  root      57313  49001  0 12:01 pts/1    00:00:00 sh -c /root/008/open-devops/meta/3/script 
  root      57314  57313  0 12:01 pts/1    00:00:00 ping baidu.com
  root      57977  57576  0 12:01 pts/3    00:00:00 grep --color=auto 57313
  [root@prome-master01 ~]# ps -ef |grep 49001
  root      49001  20207  0 11:54 pts/1    00:00:00 ./agent
  root      57313  49001  0 12:01 pts/1    00:00:00 sh -c /root/008/open-devops/meta/3/script 
  root      58236  57576  0 12:02 pts/3    00:00:00 grep --color=auto 49001

  ```
- 在数据库中更新这个任务的 action 为 kill，观察任务 3 的 meta 目录
- ```shell
  [root@prome-master01 3]# ll
  总用量 24
  -rw-r--r-- 1 root root     6 11月 28 12:03 0.done
  -rw-r--r-- 1 root root     4 11月 28 12:01 account
  -rw-r--r-- 1 root root     0 11月 28 12:01 args
  -rwxr-xr-x 1 root root    15 11月 28 12:01 script
  -rw-r--r-- 1 root root     0 11月 28 12:03 stderr
  -rw-r--r-- 1 root root 10746 11月 28 12:03 stdout
  [root@prome-master01 3]# cat 0.done 
  killed[root@prome-master01 3]# 

  ```
- 查看 agent 的日志，能发现对应的 kill 信息打印
- ```
  2021-11-28 12:01:31.814478 INFO taskjob/task.go:214 [scriptFile:/root/008/open-devops/meta/3/script][shCmd:/root/008/open-devops/meta/3/script ]
  2021-11-28 12:03:46.808816 DEBUG taskjob/task.go:279 begin kill process of task[3]
  2021-11-28 12:03:46.813157 DEBUG taskjob/task.go:287 process of task[3] killed

  ```
- 再次查看 meta 表，发现任务被标记为 done
- ```
  mysql> select * from task_meta;
  +----+--------+---------+---------+------------------------------------+----------------------+------+---------+--------+---------------------+------+
  | id | title  | account | timeout | hosts_raw                          | script               | args | creator | action | created             | done |
  +----+--------+---------+---------+------------------------------------+----------------------+------+---------+--------+---------------------+------+
  |  1 | test01 | root    |       5 | ["192.168.3.200", "192.168.3.201"] | #!/bin/bash
  ss -ntlp |      | xiaoyi  |        | 2021-11-28 11:55:51 |    1 |
  |  2 | test02 | root    |       5 | ["192.168.3.200", "192.168.3.201"] | ping -c 4 baidu.com  |      | xiaoyi  |        | 2021-11-28 11:57:51 |    1 |
  |  3 | test03 | root    |     600 | ["192.168.3.200", "192.168.3.201"] | ping  baidu.com      |      | xiaoyi  | kill   | 2021-11-28 12:03:51 |    1 |
  +----+--------+---------+---------+------------------------------------+----------------------+------+---------+--------+---------------------+------+
  3 rows in set (0.00 sec)


  ```

## 05 修改代码，新增一个 Kill 的 Http 操作，把上面 Update 数据库 Meta action=kill 的操作 给它 Web 化

- 添加路由 ，位置 D:\go_path\src\open-devops\src\modules\server\web\route.go
- ```
  		api.POST("/kill-task", TaskKill)
  ```
- taskkill 的逻辑，解析出 task_id，更新对应 task 的 action 为 kill
- ```go
  func TaskKill(c *gin.Context) {

  	taskId, err := strconv.Atoi(c.DefaultQuery("task_id", "0"))
  	if err != nil || taskId == 0 {
  		common.JSONR(c, 400, err)
  		return
  	}
  	err = models.SetTaskKill(int64(taskId))
  	if err != nil {
  		common.JSONR(c, 500, err)
  		return
  	}

  	common.JSONR(c, "success")
  }

  ```
- 需要在 models 中做 setaction kill 的逻辑,位置 D:\go_path\src\open-devops\src\models\task_meta.go
- ```go
  // 将任务的action设置为kill
  func SetTaskKill(id int64) error {
  	session := DB["stree"].NewSession()
  	defer session.Close()
  	if err := session.Begin(); err != nil {
  		return err
  	}

  	sql := fmt.Sprintf("UPDATE task_meta SET action='kill'  WHERE id=%d ", id)

  	if _, err := session.Exec(sql); err != nil {
  		session.Rollback()
  		return err
  	}

  	return session.Commit()
  }
  ```
- 测试，新增一个 ping qq.com 的逻辑
- ```python
  def task_add():
      """

  CREATE TABLE `task_meta`
  (
      `id`        bigint unsigned NOT NULL AUTO_INCREMENT,
      `title`     varchar(255)    not null default '' COMMENT '标题',
      `account`   varchar(64)     not null COMMENT '脚本执行账号',
      `timeout`   int unsigned    not null default 0  COMMENT '执行超时',
      `hosts_raw` varchar(4096)   not null  COMMENT '执行机器的ip列表json',
      `script`    text            not null COMMENT '执行的脚本',
      `args`      varchar(512)    not null default '' COMMENT '执行的脚本的参数',
      `creator`   varchar(64)     not null default '' COMMENT '创建者',
      `created`   timestamp       not null COMMENT '创建时间',
      `done`      int unsigned    not null COMMENT '任务结束与否的标志位=0未结束，=1结束',
      PRIMARY KEY (`id`),
      KEY (`created`)
  ) ENGINE = InnoDB
    DEFAULT CHARSET = utf8;
      """

      data = {
          "script": '''ping  qq.com''',
          # "script": '''#!/bin/bash\nss -ntlp''',
          "account": "root",
          "title": "test04",
          "timeout": 600,
          "hosts": json.dumps(["192.168.3.200", "192.168.3.201"]),
          "creator": "xiaoyi",
          # "action": "kill",
          # "created": 123,
          # "done": "0",
          # "tag_json": json.dumps(tag),

      }
      print(data)
      uri = 'http://192.168.3.200:8082/api/v1/task'
      # uri = 'http://localhost:8082/api/v1/task'
      res = requests.post(uri, json=data, headers=JSON_H)
      print(curlify.to_curl(res.request))
      print(res.status_code)
      print(res.text)

  ```
- 启动它，通过 web 将这个任务 kill 掉
- ```python

  def task_kill():
      uri = 'http://localhost:8082/api/v1/kill-task'
      uri = 'http://192.168.3.200:8082/api/v1/kill-task'
      params = {
          "task_id": 4
      }
      res = requests.post(uri, params=params, headers=JSON_H)
      print(curlify.to_curl(res.request))
      print(res.status_code)
      print(res.text)
  ```
- 观察 agent 日志发现确实被 kill 了
- ```

  2021-11-28 12:15:58.570527 INFO taskjob/task.go:214 [scriptFile:/root/008/open-devops/meta/4/script][shCmd:/root/008/open-devops/meta/4/script ]
  2021-11-28 12:17:43.564686 DEBUG taskjob/task.go:279 begin kill process of task[4]
  2021-11-28 12:17:43.569042 DEBUG taskjob/task.go:287 process of task[4] killed

  ```
