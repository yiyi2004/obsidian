![image-20240302151137398](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302151137398.png)

dbquery 扩展性 HTTP 的模块。cache

![image-20240302151302685](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302151302685.png)

中间 panic 不会释放锁

当锁是指针的时候，必须初始化。

如果锁不加指针，那么一定要指针接收器

![image-20240302152314296](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302152314296.png)

- viper wroking directory 调节配置的问题，当前工作目录的 config 文件
- 相对路径的定位一定是当前工作路径的相对

![image-20240302154642093](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302154642093.png)

账号密码的信息不能修改，而且不能展示在配置中，sms 中的敏感信息。

实时更新，使用配置中心，配置中心，实时生效。0~10 随机数 < 1 控制流量

etcd 是不错的选择

git tag

![image-20240302155344397](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302155344397.png)

集群就是 , 分开

![image-20240302160214254](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302160214254.png)

- 应该告诉你文件变了，但是不能告诉你文件中的哪些 key 变了。
- 远程配置文件改了之后不会有反应
- 统一配置 API

初始化的时候使用配置，只需要在 ioc 配置。

![image-20240302160822279](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302160822279.png)

- 封装类似于 viper 的接口

权限控制的 KPI

灰度发布 一开始只是 10% 后面是 20%

uber/atomic

![image-20240302161253307](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302161253307.png)

- 配置文件修改之后应该如何操作。

![image-20240302162946256](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302162946256.png)

![image-20240302163107762](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302163107762.png)

db 会自动关闭，连接。

Go-Admin 系统，是不错的实现

1. 推行规范

![image-20240302200149761](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302200149761.png)

- 在 web 层面上打印日志。

![image-20240302201412666](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302201412666.png)

- 优雅实现

依赖注入风格：

![image-20240302201806607](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302201806607.png)

留了将来变化的空间。

![image-20240302203036682](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302203036682.png)

stream 读完就没有了。

![image-20240302203323861](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240302203323861.png)

只想实现特定的方法，就用组合去解决。

老板大气，

正确的代码放在正确的地方，高内聚，低耦合。小心日志内容很多。

viper 监听动态开关，

![image-20240305152147007](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305152147007.png)

- 小心并发安全的问题，所以要用原子操作，使用 uber 的 atomic 更加好用
- 动态监听变更，监听配置项。在初始化的过程中监听

![image-20240305152500034](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305152500034.png)

- 上面的文档，需要仔细研究一下。
- MQ 的问题是不可追溯，归档时间。
- MQ + MySQL。
- 高大上 消息队列。但是又延迟。

## Gorm 日志不太好用

![image-20240305153107392](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305153107392.png)

![image-20240305153453772](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305153453772.png)

- 单接口的方法，可以使用给 func 添加方法去实现接口，这是一种适配器模式。

![image-20240305153731262](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305153731262.png)

比较奇诡的方法，改源码，然后进行配置，如果发现是 password 然后改成 xxx

callback

gorm 讲到这里

接口可以使用装饰器方法，加入日志的功能

**在百万 QPS 之前，不要考虑日志的开销**

![image-20240305154142730](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305154142730.png)

- 使用的 AOP 机制是怎么使用的呢？

认真态度 + 工程态度

- 日志规范，什么时候告警。
- 信息量要足够
- 考虑别人的抵触
- 大厂规范 + 进行筛选

日志 + tracing + metrics 响应时间

日志 + 可观测性 + ELK，改善性能和可用性 + 快速发现问题。

![image-20240305154531597](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305154531597.png)

性能 + 缓存的命中率比较低。

metrics 度量 响应时间 命中率 prometheus，尝试

- 任务：提供 AOP 机制 —— 日志系统
- 统一处理 web 响应
- 要非常的通用

![image-20240305155408745](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305155408745.png)

- 利用泛型简化操作
- 也可以把 userClaims 取出来
  - 真的是优秀的代码实现
