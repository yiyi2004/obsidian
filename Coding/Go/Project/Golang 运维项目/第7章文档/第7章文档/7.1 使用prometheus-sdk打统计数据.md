# 需求分析

> 使用prometheus go-sdk打点

- sdk地址 https://github.com/prometheus/client_golang

> 和gin在一起如何使用

- 使用这个库 https://github.com/zsais/go-gin-prometheus
- D:\go_path\src\open-devops\src\modules\server\web\http.go

```go
package web

import (
	"github.com/gin-gonic/gin"
	"github.com/go-kit/log"
	"github.com/go-kit/log/level"
	"github.com/zsais/go-gin-prometheus"
	"net/http"
	"time"
)

func StartGin(httpAddr string, logger log.Logger) error {
	r := gin.New()

	gin.SetMode(gin.ReleaseMode)
	gin.DisableConsoleColor()

	p := ginprometheus.NewPrometheus("xiaoyi")
	p.Use(r)
	r.Use(gin.Logger())

	m := make(map[string]interface{})
	m["logger"] = logger
	r.Use(ConfigMiddleware(m))

	// 设置路由
	configRoutes(r)
	s := &http.Server{
		Addr:           httpAddr,
		Handler:        r,
		ReadTimeout:    time.Second * 5,
		WriteTimeout:   time.Second * 5,
		MaxHeaderBytes: 1 << 20,
	}
	level.Info(logger).Log("msg", "web_server_available_at", "httpAddr", httpAddr)

	err := s.ListenAndServe()
	return err
}

```

> 启动服务后方位 /metrics接口 查看是否有默认的指标

```shell
promhttp_metric_handler_requests_total{code="200"} 22
promhttp_metric_handler_requests_total{code="500"} 0
promhttp_metric_handler_requests_total{code="503"} 0
# HELP xiaoyi_request_duration_seconds The HTTP request latencies in seconds.
# TYPE xiaoyi_request_duration_seconds summary
xiaoyi_request_duration_seconds_sum 0.0199621
xiaoyi_request_duration_seconds_count 8
# HELP xiaoyi_request_size_bytes The HTTP request sizes in bytes.
# TYPE xiaoyi_request_size_bytes summary
xiaoyi_request_size_bytes_sum 2694
xiaoyi_request_size_bytes_count 8
# HELP xiaoyi_requests_total How many HTTP requests processed, partitioned by status code and HTTP method.
# TYPE xiaoyi_requests_total counter
xiaoyi_requests_total{code="200",handler="open-devops/src/modules/server/web.GetLabelDistribution",host="localhost:8082",method="POST",url="/api/v1/resource-distribution?page_size=1200"} 3
xiaoyi_requests_total{code="200",handler="open-devops/src/modules/server/web.ResourceGroup",host="localhost:8082",method="GET",url="/api/v1/resource-group?label=stree_group&resource_type=resource_host"} 1
xiaoyi_requests_total{code="200",handler="open-devops/src/modules/server/web.ResourceQuery",host="localhost:8082",method="POST",url="/api/v1/resource-query?page_size=1200"} 4
# HELP xiaoyi_response_size_bytes The HTTP response sizes in bytes.
# TYPE xiaoyi_response_size_bytes summary
xiaoyi_response_size_bytes_sum 54193
xiaoyi_response_size_bytes_count 8
```

# 新增metric包做统计使用

- D:\go_path\src\open-devops\src\modules\server\metric\metrics.go
- resource_index_flush_last_seconds代表 索引刷新的时间
- resource_num_count代表 资源个数统计

```go
	// 耗时统计的
	// 刷索引
	IndexFlushDuration = prometheus.NewGaugeVec(prometheus.GaugeOpts{
		Name: "resource_index_flush_last_duration_seconds",
		Help: "Duration of index flush  ",
	}, []string{common.LABEL_RESOURCE_TYPE})

	// 公有云同步
	PublicCloudSyncDuration = prometheus.NewGaugeVec(prometheus.GaugeOpts{
		Name: "public_cloud_sync_last_duration_seconds",
		Help: "Duration of public cloud sync",
	}, []string{common.LABEL_RESOURCE_TYPE})
```

- 编写注册metrics函数

```go
func NewMetrics() {

	prometheus.DefaultRegisterer.MustRegister(IndexFlushDuration)
	prometheus.DefaultRegisterer.MustRegister(ResourceNumCount)

}

```

- main中添加相关调用

> 编写这两个指标的打点实例

- 在刷新索引的时候 可以拿到全量的资源，并且能统计索引刷新的时间
- D:\go_path\src\open-devops\src\modules\server\mem-index\host.go
- 依次填入label，不能多也不能少 ，并设置float64的值即可

```go
func (hi *HostIndex) FlushIndex() {
	// 数个数
	start := time.Now()
	r := new(models.ResourceHost)
	total := int(r.Count())
	metric.ResourceNumCount.With(prometheus.Labels{common.RESOURCE_TYPE: common.RESOURCE_HOST}).Set(float64(total))

```

- 在doIndexSync遍历调用各个resource 的flushindex方法时可以在 外层及时算刷新耗时
- D:\go_path\src\open-devops\src\modules\server\mem-index\index.go

```go
func doIndexFlush() {
	var wg sync.WaitGroup
	wg.Add(len(indexContainer))
	for name, ir := range indexContainer {
		name := name
		ir := ir
		go func() {
			defer wg.Done()
			start := time.Now()
			ir.FlushIndex()
			metric.IndexFlushDuration.With(prometheus.Labels{common.LABEL_RESOURCE_TYPE: name}).Set(float64(time.Since(start).Seconds()))

		}()
	}
	wg.Wait()
}
```

> 重新启动能在metrics页面看到这两个指标

```shell
# HELP resource_index_flush_last_seconds Duration of index flush  
# TYPE resource_index_flush_last_seconds gauge
resource_index_flush_last_seconds{resource_type="resource_host"} 0.0217844

# HELP resource_num_count Num of resource
# TYPE resource_num_count gauge
resource_num_count{resource_type="resource_host"} 41
```

> 和索引同步时间一样的 公有云同步时间指标

- D:\go_path\src\open-devops\src\modules\server\sync\cloud_sync.go
- 也是在统一的地方做，这样写一遍就可以了

# 根据倒排索引的分组统计指标

> 需求分析

- 比如看到 host在 region 、cloud_provider等关键标签上的分布情况
- 也就是要调用各个资源索引的 group接口，传入region 、cloud_provider等关键标签即可

> 落地需求

- 新建 D:\go_path\src\open-devops\src\modules\server\statistics\tree_sta.go
- ticker

```go
func TreeNodeStatisticsManager(ctx context.Context, logger log.Logger) error {

	level.Info(logger).Log("msg", "TreeNodeStatisticsManager.start")
	ticker := time.NewTicker(15 * time.Second)
	defer ticker.Stop()
	for {
		select {
		case <-ctx.Done():
			level.Info(logger).Log("msg", "TreeNodeStatisticsManager.exit.receive_quit_signal")
			return nil
		case <-ticker.C:
			level.Debug(logger).Log("msg", "statisticsWork.cron")

			statisticsWork(logger)
		}
	}
}

```

- 并在main中启用

> 核心统计方法

- D:\go_path\src\open-devops\src\modules\server\statistics\tree_sta.go

```go
func statisticsWork(logger log.Logger) {

	irs:=mem_index.GetAllResourceIndexReader()
	level.Info(logger).Log("msg", "statisticsWork.start.num","num",len(irs))
	for resourceType,ir :=range irs{
		ir:=ir
		// 按region的分布
		s:=ir.GetIndexReader().GetGroupByLabel(common.LABEL_REGION)

		for _,i:=range s.Group{
			metric.ResourceNumRegionCount.With(prometheus.Labels{common.LABEL_RESOURCE_TYPE:resourceType,common.LABEL_REGION:i.Name}).Set(float64(i.Value))
		}
		// 按cloud_provider的分布
		p:=ir.GetIndexReader().GetGroupByLabel(common.LABEL_CLOUD_PROVIDER)

		for _,i:=range p.Group{
			metric.ResourceNumCloudProviderCount.With(prometheus.Labels{common.LABEL_RESOURCE_TYPE:resourceType,common.LABEL_CLOUD_PROVIDER:i.Name}).Set(float64(i.Value))
		}

	}

}
```

# 需要一个 按照每个g.p.a统计资源的方法

> 需求分析
>

> 所以需要一个从 stree_path表中获取全量g.p.a列表的方法

- D:\go_path\src\open-devops\src\models\stree_path.go
- 扩展一下之前的核心查询方法 StreePathQuery
- 新增type=5 的，// 获取全量g.p.a ，给统计用的

```go
	case 5:
		// 获取全量g.p.a ，给统计用的
		whereStr := "id>0"
		ps, err := StreePathGetMany(whereStr)
		if err != nil {
			return
		}
		existMapGS := make(map[int64]StreePath)
		existMapPS := make(map[int64]StreePath)
		existMapAS := make(map[int64]StreePath)

		for _, p := range ps {
			switch p.Level {
			case 1:
				existMapGS[p.Id] = p
			case 2:
				existMapPS[p.Id] = p
			case 3:
				existMapAS[p.Id] = p
			}
		}

		for gid, g := range existMapGS {

			for pid, p := range existMapPS {
				pPath := fmt.Sprintf("/%d", gid)
				if pPath == p.Path {
					for _, a := range existMapAS {
						aPath := fmt.Sprintf("%s/%d", p.Path, pid)
						if aPath == a.Path {
							res = append(res, fmt.Sprintf("%s.%s.%s", g.NodeName, p.NodeName, a.NodeName))
						}

					}
				}

			}
		}
		return

	}
```

- 原理很简单 ，从db中get all，get_all可以使用 StreePathGetMany 传入 id>0即可
- 然后遍历结果，赋值到三个level的map中
- 然后逐次遍历三个level的map ，上层的path和本层中的path一直就继续遍历
- 然后add

> python 调用测试

```python
def node_path_query():
    data = {
        "target_path": "waimai.ditu.es",
        "resource_type": "resource_host",
        "resource_ids": [1],

    }
    data = {"node": "a1", "query_type": 5}
    print(data)
    uri = 'http://localhost:8082/api/v1/node-path'
    res = requests.get(uri, json=data, headers=JSON_H)
    print(curlify.to_curl(res.request))
    print(res.status_code)
    print(res.text)


```

- 结果

```shell
curl -X GET -H 'Accept: */*' -H 'Accept-Encoding: gzip, deflate' -H 'Connection: keep-alive' -H 'Content-Length: 31' -H 'Content-Type: application/json' -H 'User-Agent: python-requests/2.25.1' -d '{"node": "a1", "query_type": 5}' http://localhost:8088/api/v1/node-path
200
["ads.monitor.kafka","ads.monitor.prometheus","ads.monitor.zookeeper","ads.cicd.prometheus","ads.cicd.kafka","ads.cicd.zookeeper","ads.k8s.zookeeper","ads.k8s.prometheus","ads.k8s.kafka","inf.k8s.kafka","inf.k8s.prometheus","inf.k8s.zookeeper","inf.cicd.prometheus","inf.cicd.zookeeper","inf.cicd.kafka","inf.monitor.kafka","inf.monitor.zookeeper","inf.monitor.prometheus","web.monitor.zookeeper","web.monitor.kafka","web.monitor.prometheus","web.k8s.prometheus","web.k8s.zookeeper","web.k8s.kafka","web.cicd.prometheus","web.cicd.kafka","web.cicd.zookeeper"]

```

## 落地这个方案

> 把statisticsWork 改造成并发做

- 因为每种资源独立

> 获取所有的g.p.a列表

```go
allGPAS := models.StreePathQuery(qReq, logger)
```

> 封装统一的打点方法

- 这些metrics都有共同的特点
- common.LABEL_GPA_NAME, common.LABEL_RESOURCE_TYPE, common.LABEL_REGION 三个标签
- 一个独特的标签，而且metrics类型都是 prometheus.NewGaugeVec
- 所以可以封装一个共同的metrics

```go
	GPAAllNumRegionCount = prometheus.NewGaugeVec(prometheus.GaugeOpts{
		Name: "gpa_all_region_num_count",
		Help: "Num gpa of all with tag region",
	}, []string{common.LABEL_GPA_NAME, common.LABEL_RESOURCE_TYPE, common.LABEL_REGION})
```

- 带分析标签的方法如下

```go
func gpaLabelNumWork(resourceType string, targetLabel string, gpaName string, matcher []*common.SingleTagReq, ir mem_index.ResourceIndexer, ms *prometheus.GaugeVec) {
	req := common.ResourceQueryReq{
		ResourceType: resourceType,
		Labels:       matcher,
		TargetLabel:  targetLabel,
	}
	matchIds := mem_index.GetMatchIdsByIndex(req)
	statsRs := ir.GetIndexReader().GetGroupDistributionByLabel(req.TargetLabel, matchIds)
	for _, x := range statsRs.Group {

		ms.With(prometheus.Labels{
			common.LABEL_GPA_NAME:      gpaName,
			common.LABEL_RESOURCE_TYPE: resourceType,
			targetLabel:                x.Name,
		}).Set(float64(x.Value))

	}

}

```

- 单纯统计个数的

```go
// 通过索引的 GetGroupByLabel接口获取个数分布
// 每个g.p.a在每种资源上的计数统计
func gpaNumWork(resourceType string, gpaName string, matcher []*common.SingleTagReq, ms *prometheus.GaugeVec) {

	req := common.ResourceQueryReq{
		ResourceType: resourceType,
		Labels:       matcher,
	}

	matchIds := mem_index.GetMatchIdsByIndex(req)
	if len(matchIds) > 0 {
		ms.With(prometheus.Labels{
			common.LABEL_GPA_NAME:      gpaName,
			common.LABEL_RESOURCE_TYPE: resourceType,
		}).Set(float64(len(matchIds)))

	}

}

```

- 要求 g g.p g.p.a在每个维度上都要统计一次

> 查看metrics页面的结果值

```shell
gpa_all_region_num_count{gpa_name="ads",region="beijing",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads",region="guangzhou",resource_type="resource_host"} 6
gpa_all_region_num_count{gpa_name="ads",region="shanghai",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads",region="tianjin",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.cicd",region="beijing",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.cicd",region="guangzhou",resource_type="resource_host"} 6
gpa_all_region_num_count{gpa_name="ads.cicd",region="shanghai",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.cicd",region="tianjin",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.cicd.prometheus",region="guangzhou",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.cicd.zookeeper",region="guangzhou",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.k8s",region="beijing",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.k8s",region="guangzhou",resource_type="resource_host"} 6
gpa_all_region_num_count{gpa_name="ads.k8s",region="shanghai",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.k8s",region="tianjin",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.k8s.kafka",region="guangzhou",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.k8s.kafka",region="tianjin",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.k8s.prometheus",region="guangzhou",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.k8s.zookeeper",region="shanghai",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor",region="beijing",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor",region="guangzhou",resource_type="resource_host"} 6
gpa_all_region_num_count{gpa_name="ads.monitor",region="shanghai",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.monitor",region="tianjin",resource_type="resource_host"} 4
gpa_all_region_num_count{gpa_name="ads.monitor.kafka",region="beijing",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor.kafka",region="guangzhou",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor.kafka",region="shanghai",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor.kafka",region="tianjin",resource_type="resource_host"} 2
gpa_all_region_num_count{gpa_name="ads.monitor.prometheus",region="guangzhou",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor.prometheus",region="shanghai",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor.zookeeper",region="shanghai",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="ads.monitor.zookeeper",region="tianjin",resource_type="resource_host"} 1
gpa_all_region_num_count{gpa_name="inf",region="beijing",resource_type="resource_host"} 5
```

# host 特殊的统计需求

> 需求分析

- disk ，mem ，cpu数据
- agent rpc同步的时候直接采集到
- 公有云应该使用instance_type字段转换一下

> 注意点

- 还是使用倒排索引 的根据gpa 分布功能 GetGroupDistributionByLabel(req.TargetLabel, matchIds)
- 但是要的不是x.Value个数了
- 而是x.Name 就是 cpu ，mem 等的原始值
- 而且算的是总数，所以要遍历叠加

> 写封装方法

```go
// host特殊的
func hostSpecial(resourceType string, targetLabel string, gpaName string, matcher []*common.SingleTagReq, ir mem_index.ResourceIndexer, ms *prometheus.GaugeVec) {
	req := common.ResourceQueryReq{
		ResourceType: resourceType,
		Labels:       matcher,
		TargetLabel:  targetLabel,
	}

	matchIds := mem_index.GetMatchIdsByIndex(req)
	statsRe := ir.GetIndexReader().GetGroupDistributionByLabel(targetLabel, matchIds)
	var all uint64
	for _, x := range statsRe.Group {
		num, _ := strconv.Atoi(x.Name)
		all += uint64(num) * x.Value
	}
	if all > 0 {
		ms.With(prometheus.Labels{common.LABEL_GPA_NAME: gpaName}).Set(float64(all))
	}

}

```

> 调用这个方法

> metrics效果

```shell
# HELP gpa_host_cpu_cores Num gpa cpu cores of ecs
# TYPE gpa_host_cpu_cores gauge
gpa_host_cpu_cores{gpa_name="ads"} 452
gpa_host_cpu_cores{gpa_name="ads.cicd"} 104
gpa_host_cpu_cores{gpa_name="ads.cicd.kafka"} 16
gpa_host_cpu_cores{gpa_name="ads.cicd.prometheus"} 8
gpa_host_cpu_cores{gpa_name="ads.cicd.zookeeper"} 80
gpa_host_cpu_cores{gpa_name="ads.k8s"} 176
gpa_host_cpu_cores{gpa_name="ads.k8s.kafka"} 20
gpa_host_cpu_cores{gpa_name="ads.k8s.prometheus"} 140
gpa_host_cpu_cores{gpa_name="ads.k8s.zookeeper"} 16
gpa_host_cpu_cores{gpa_name="ads.monitor"} 172
gpa_host_cpu_cores{gpa_name="ads.monitor.kafka"} 80
gpa_host_cpu_cores{gpa_name="ads.monitor.prometheus"} 28
gpa_host_cpu_cores{gpa_name="ads.monitor.zookeeper"} 64
gpa_host_cpu_cores{gpa_name="inf"} 356
gpa_host_cpu_cores{gpa_name="inf.cicd"} 96
gpa_host_cpu_cores{gpa_name="inf.cicd.prometheus"} 80
gpa_host_cpu_cores{gpa_name="inf.cicd.zookeeper"} 16
gpa_host_cpu_cores{gpa_name="inf.k8s"} 84
gpa_host_cpu_cores{gpa_name="inf.k8s.kafka"} 48
gpa_host_cpu_cores{gpa_name="inf.k8s.zookeeper"} 36
gpa_host_cpu_cores{gpa_name="inf.monitor"} 176
gpa_host_cpu_cores{gpa_name="inf.monitor.prometheus"} 112
gpa_host_cpu_cores{gpa_name="inf.monitor.zookeeper"} 64
```

# 部署服务，让prometheus过来采集

```yaml
  - job_name: "stree"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["192.168.3.7:8082"]

```

# 编写grafana-dashboard

- 成品https://grafana.com/grafana/dashboards/14864

> 编写变量
> ![04.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1637741808000/edd2f2ac94a44a97a0fdf5f112fa1c8c.png)

> 资源总览
> ![01.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1637741808000/be4de633b4c14e50b5da1c90459669e9.png)

> gpa资源统计
> ![gpg01.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1637741808000/04180a1837aa4ae89a0f200dbeb6da56.png)

> host cpu mem disk
> ![03.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1637741808000/57a3b7158f6744d7abd2926d6fae7543.png)