## 发帖子功能实现

1. 需求分析
   1. 用例
   2. 可见性
   3. 状态流转
   4. 流程分析
2. TDD 与编辑接口
3. 发表接口起步
   1. 制作库和线上库的概念
      1. 不同库
      2. 同库不同表 简单应用
   2. TDD 发表接口 基于单元测试的 TDD
   3. service 层同步数据
4. 同步数据
   1. service 层同步数据
   2. repository 层同步数据
      1. 非实物实现
      2. 事务问题
   3. dao 层同步数据
      1. 本地事务实现
5. 发表接口总结
6. 维护状态
7. 使用 MongoDB 存储
8. 使用 OSS 存储
9. 查询接口

## 需求分析

## TDD

1. 初步定义接口
2. 根据结构定义测试
3. 执行核心循环
   1. 增加测试用例
   2. 提供/修改实现
   3. 执行测试用例

![image-20240305192924125](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305192924125.png)

微服务框架，go 优雅编程。

时间的断言

gorm 忽略零值的变化.

可读性是重要的，把代码写的更加清晰一点。

创作者

用户领域

一个领域中的实体，在另一个领域之间是一个字段。

- save or create 最好返回一个 id
- 修改没有影响之前的行为

另外一个问题 id

如果有些字段不能修改，整体失败，原子操作行为。

1. 先查询 对比 性能差

TDD 的代码的稳定性，覆盖率会很好。会让你的代码的质量很高。

反复提测是效率更低的一件事

## 发表文章

make mock 顶级没目录，如何使用

gomock 的使用，

web 聚合服务

![image-20240305202031812](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305202031812.png)

中间件的研发团队，**不同的角度处理不同的数据源的问题**

id 要保证制作库和线上库的一致。

现在业务开始变得复杂了。所以 TDD 是可以提升你的代码质量的。我哪天总结一下这个的所有内容，然后放在自己的简历里面，真不错。

- 部分失败的效果。
- 分支覆盖

你不一定开得了事务，

![image-20240305203703550](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305203703550.png)

- service 层不适合开事务。
- 数据库事务应该是 repository 上开的事务。
- 通过重试机制

分布式非常的难搞哦

装饰器模式，装饰器去重试。

对应的测试用例要加

初始化

![image-20240305204151565](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240305204151565.png)

通过**重试**，降低失败的概率。

不会规避，一段时间处理的问题。

**指数退避类的重试**

或者异步，临时保存到本地文件 没有特别大意义

Canel 监听 binlog，不需要同步，canal 会帮你

MQ 另一套系统帮你

1. 不能删除老数据。

分布式事务的 AT 模式，生成相反的 update 的，恢复数据。

启动 goroutine 修复

使用 canal status

TCC 两个微服务

6+6 12小时

1. 执行流程最长的

事务开启之后，如果 panic 不会回滚或者提交

```go
defer tx.Rollback()
```

![image-20240306102752344](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240306102752344.png)

- repository 

![image-20240306102905234](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240306102905234.png)

- repository 还是用来操作缓存和 DAO，DAO 应该是来操作事务

upsert 操作

开事务之后会一直拿着数据库的连接

gorm 事务闭包是如何实现的。—— panic

![image-20240306133116360](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240306133116360.png)

- DAO 的层面上开启事务，数据库的事务，2~3 张表是有关联关系的。

事务传播机制依赖 thread local 机制，没有 API 操作当前的 goroutine

## 总结

没有学的东西

1. 增强功能
2. 作业
3. 查询接口与缓存
