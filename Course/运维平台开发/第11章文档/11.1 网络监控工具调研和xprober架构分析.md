## 需求分析

### 网络监控工具调研

- 多 region 为一般公司内网架构
- 这个工具能提供网络性能数据监控
- 同时也参考调研了 tor 维度的 [pingmesh方案](https://zdyxry.github.io/2020/03/26/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB-%E3%80%8APingmesh-A-Large-Scale-System-for-Data-Center-Network-Latency-Measurement-and-Analysis%E3%80%8B/)![ping_mesh.jpg](https://image-static.segmentfault.com/234/691/2346912697-5f06b9fa600f0_fix732)

### 总结

**key1** 其实最主要能看到公有混合云内网所有 region 两两之间的延迟和丢包率

- 维度落在 region 而不是 tor，即不关心同 region 内的延迟
- 如果采用单个 agent 集中向外探测的问题: 效率问题、探测节点网络质量问题导致结果出错
- 不关心单个 ip 或 vip 的结果，而是需要用多个 ip 结果汇总代表这个 region 的网络质量
- c/s 架构: client 负责探测，server 生成/配置探测 target 池，server 通过 rpc 下发个体 client target ，agent 通过 rpc 上报探测结果给 server 端处理
- 被探测 target 列表支持配置同时能更 " 智能点 ",所以设置成 agent 启动后能自动生成 target 池:

```
eg: 4个region{a-d}中各2个vm{1-8}，结果就是不同reigon间的vm需要互相探测，vm1的target就是vm{3-8} ，vm3的target就是vm{1，2,4-8} 
```

- agent 为公有云的 vm，获取 region 并上报 reigon 和 ip

```
公有云上的vm 利用接口http://169.254.169.254/latest/meta-data/placement/availability-zone 可以获取vm的region
```

**key2** 能够对关键 http 接口发起探测

- 要能覆盖整个 http 各个 stage
- 能够反映内网各个 region 到此接口的延迟情况

**key3** 数据接入 prometheus，由 grafana 展示

## 架构图

![image](https://image-static.segmentfault.com/385/302/3853027722-6059b794144d0_fix732)

## Xprober 的主要功能

`xprober` 是分布式 c/s 架构 ping&http 探测框架：

- Ping 监控：基于不同区域之间的公共云混合云 ec2 检测
- Ping 监控：根据代理启动来建立目标池，可以获取两个区域的 Ping 结果作为彼此的源和目标
- 目标源：同时，它还支持服务器端配置文件以指定目标
- Http 监控：它可以获取从不同区域到目标接口在不同 http 阶段花费的时间

### 预览图

#### Http 探测结果

![http.jpg](https://image-static.segmentfault.com/266/968/2669683632-5ee18de2f043e_fix732)

#### 互 Ping 结果

![ping.jpg](https://image-static.segmentfault.com/274/440/2744408427-5ee18dedcb98b_fix732)

#### 专线延迟报警

![专线报警.jpg](https://image-static.segmentfault.com/999/522/999522447-5f06ca329f3cb_fix732)

## 如何使用

- 在公有云各个 region 中各开至少 2 个小规格的 vm: 1c2g 即可
- 编译并部署 server 服务
- 编译并部署 agent 服务
- 准备 prometheus 和 grafana
