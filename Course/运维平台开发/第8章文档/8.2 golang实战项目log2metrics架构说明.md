## 本节重点介绍

- 需求分析
- 流程说明
- log2metrics 架构设计

## 架构图

![log2metrics.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1630721301000/93083cd1c9924518868bc94f9baba35e.png)

## 需求分析

### 算 Qps

- 比如统计 nginx 日志中 code=200 的 qps
- 对应就是 每隔 10 秒 grep 一下日志文件 ，用增量/时间差 算出 qps

### 日志关键字告警

#### 错误类型的关键字举例

- 如应用连接 mysql 报错 `dial mysql host error `
- 如 redis 同步失败报错 `cannot sync data `
- 如进程被 oom kill 了 `Out of Memory (OOM) killer`

## 流程说明

### 配置采集任务

- 采集任务的名称
- 指定暴露的 metrics 名称 如 ngx_access_cnt
- 指定日志路径
- 提供日志匹配正则 ，如过滤包含 containerd 的日志

```shell
 ".*containerd.*"
```

- 提供标签正则，如过滤 level

```shell
      level: ".*level=(.*?) .*"
```

> 举个例子

- 小乙 希望统计 10 台 nginx 机器 code=200 301 302 400 500
  - 对应的日志文件在/var/log/nginx/access.log
  - ngx_access_qps{ip=xx,code=200,region=xxx}

### 计算方法说明

- cnt 对符合规则的日志进行计数 ，就是日志的总数 counter
- max 对符合规则的日志抓取出的数字算最大值 ，如 code=404 和 code=500 max 结果就是 500
- min 对符合规则的日志抓取出的数字算最小值
- sum 对符合规则的日志抓取出的数字算和
- avg 对符合规则的日志抓取出的数字算平均值

### 启动日志采集任务

- 启动 tailer 读取相关日志
- 将结果通过队列发送给分析组件

### 启动分析组件

- 接收 tailer 发过来的日志
- 使用正则进行分析
- 转换为统计的数据结构
- 发送给数据处理组件

### 启动数据处理组件

- 定时分析数据，转化为 prometheus metrics

## 架构图

![log2metrics.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1630721301000/93083cd1c9924518868bc94f9baba35e.png)

## 本节重点总结

- 需求分析
- 流程说明
- log2metrics 架构设计
