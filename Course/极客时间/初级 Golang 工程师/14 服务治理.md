- 理论基础
	- 故障机制
		- 故障检测
		- 故障处理
		- 故障恢复
	- 具体措施
		- 熔断
		- 限流
		- 降级
- 在 gRPC 中接入服务治理
- 不同框架接入服务治理
	- Kratos
	- go-zero
- gRPC 超时控制

## 理论基础

![[Snipaste/Pasted image 20240311194439.png]]

1. 服务治理
	1. 熔断、限流和降级
	2. 超时控制
	3. 隔离
	4. 分组和路由
	5. 优雅退出
2. 亮点：一整套的从前端到后端的服务治理方案

![[Snipaste/Pasted image 20240311194752.png]]

1. 故障检测
2. 故障处理
3. 故障恢复

![[Snipaste/Pasted image 20240311194858.png]]

1. 故障检测
	1. 静态检测：压测 + 研发人员历史经验，设定阈值
	2. 动态检测：硬件信息 + 服务本身信息 (响应时间、错误率) 等来判断

![[Snipaste/Pasted image 20240311200958.png]]

1. 故障处理的方式玩的花样很多
	1. 同步转异步：把请求记录下来，后续再处理
	2. 执行特殊代码：对于熔断、限流来说，就是返回 error；对于降级来说，可能是返回默认值，或者执行一个快路径
	3. 请求转发：转发到其他节点，这个过程如果通过客户端来配合，实现更加简单

![[Snipaste/Pasted image 20240311201302.png]]

1. 故障恢复的要点在于
	1. 如何确定我的服务已经恢复正常了？
		1. 固定时间等待
		2. 实时计算：故障检测算法，实时计算服务端节点的状态。
		3. 试探发
	2. 避免抖动：退出故障处理流程的时候，不要立刻引起系统再次触发故障。
		1. 基本思路：结合试探发逐步放开流量，也可以叫做灰度
2. 故障恢复如果处理不好，很容易导致出现系统一会好，一会崩溃的情况。

故障恢复通用策略

试探 + 逐步放开流量的方式

![[Snipaste/Pasted image 20240311201905.png]]

1. 故障恢复之后，试探一个请求
2. 正常处理，不能处理
3. 逐步加大流量，正常处理，出现错误
4. 不断加大流量，直到 100%
