## 本节重点介绍

- 新建项目 log2metrics
- 编写配置文件 yaml
- main 解析配置，校验正则，设置 log
- 根据配置文件设置 metrics

## 新建项目 log2metrics

### Go mod Init

```shell
go mod init log2metrics
```

## 编写配置文件 Yaml

```yaml
http_addr: 0.0.0.0:8087
log_level: INFO

log_strategy:
  - metric_name: log_containerd_total
    metric_help: /var/log/messages 中的 containerd日志 total
    file_path: /var/log/messages
    pattern:  ".*containerd.*"
    func: cnt
    tags:
      level: ".*level=(.*?) .*"
  - metric_name: ngx_acc_code
    metric_help: nginx code avg
    file_path: /var/log/nginx/access.log
    pattern:  '.*\[code=(.*?)\].*'
    func: avg
```

### log_strategy 字段解析

- metric_name : 指定暴露的 metrics 名称 如 ngx_access_cnt
- metric_help : 暴露指标的 metrics 帮助信息，支持中文
- file_path : 指定日志路径
- pattern：提供日志匹配正则 ，如过滤包含 containerd 的日志
- func ：计算方法
  - cnt 对符合规则的日志进行计数 ，就是日志的总数 counter
  - max 对符合规则的日志抓取出的数字算最大值 ，如 code=404 和 code=500 max 结果就是 500
  - min 对符合规则的日志抓取出的数字算最小值
  - sum 对符合规则的日志抓取出的数字算和
  - avg 对符合规则的日志抓取出的数字算平均值
- tags：标签的正则，
  - key=正则
  - key 最后用来设置 metrics 的标签
  - value 正则匹配的结果是标签的值

### 代码中解析配置文件

#### 日志采集策略文件

- 位置 D:\go_path\src\open-devops\src\models\log_job.go 或者合到 agent 的 config 中

```go
// 用户配置的日志策略，可以是agent 本地的yaml，也可以是通过接口过来的
type LogStrategy struct {
	ID         int64             `json:"id" yaml:"-"`
	MetricName string            `json:"metric_name" yaml:"metric_name"`
	MetricHelp string            `json:"metric_help" yaml:"metric_help"`
	FilePath   string            `json:"file_path" yaml:"file_path"`
	Pattern    string            `json:"pattern" yaml:"pattern"`
	Func       string            `json:"func" yaml:"func"`
	Tags       map[string]string `json:"tags" yaml:"tags"`
	Creator    string            `json:"creator"`
	// 上面是yaml或者前端的配置

	PatternReg *regexp.Regexp            `json:"-" yaml:"-"` // 主正则
	TagRegs    map[string]*regexp.Regexp `json:"-" yaml:"-"` // 标签的正则

}
```

#### 解析配置的方法

- 位置 config/config.go

```go
// 解析用户配置的日志策略正则
func SetLogRegs(input []*models.LogStrategy) []*models.LogStrategy {
	res := []*models.LogStrategy{}
	for _, st := range input {
		st := st
		st.TagRegs = make(map[string]*regexp.Regexp)
		// 处理主正则
		if len(st.Pattern) != 0 {
			reg, err := regexp.Compile(st.Pattern)
			if err != nil {
				fmt.Printf("compile pattern regexp failed:[name:%v][pat:%v][err:%v]\n",
					st.MetricName,
					st.Pattern,
					err,
				)
				continue
			}
			st.PatternReg = reg
		}
		// 处理标签的正则
		for tagK, tagv := range st.Tags {
			reg, err := regexp.Compile(tagv)
			if err != nil {
				fmt.Printf("compile pattern regexp failed:[name:%v][pat:%v][err:%v]\n",
					st.MetricName,
					tagv,
					err,
				)
				continue
			}
			st.TagRegs[tagK] = reg
		}
		res = append(res, st)
	}
	return res
}

```

##### updateRegs 校验用户配置的正则

- 使用 regexp.Compile 解析 st.Pattern
- 如果报错了说明用户配置的正则不对，那么就忽略这个配置
- 对于标签的正则 st.TagRegs 的处理方式是
  - 如果一个正则配置错误就忽略这个标签

## Main 解析配置，设置 Log

### 解析命令行

### 解析配置文件和设置 Log

## 根据配置文件设置 Metrics

- 位置 metrics/metrics.go

```go
package metric

import (
	"github.com/prometheus/client_golang/prometheus"
	"open-devops/src/modules/agent/config"
)

func CreateMetrics(ss []*config.LogStrategy) map[string]*prometheus.GaugeVec {

	mmap := make(map[string]*prometheus.GaugeVec)
	for _, s := range ss {
		labels := []string{}

		for k := range s.Tags {
			labels = append(labels, k)
		}
		m := prometheus.NewGaugeVec(prometheus.GaugeOpts{
			Name: s.MetricName,
			Help: s.MetricHelp,
		}, labels)
		mmap[s.MetricName] = m

	}
	return mmap
}

```

### 解读

- 遍历配置文件解析完之后的策略数组
- 初始化一个 gauge 类型的 metrics
  - 名字为用户配置的 MetricName
  - Help 为用户配置的 MetricHelp
  - labels 为用户配置的 tags 的 key
- 以 metrics 的 name 为 key，value 是这个 metrics 创建一个 map

### main.go 中创建这个 Metrics 的 Map

- 遍历 metrics map，注册 metrics

```go
	// 创建metrics
	metricsMap := metrics.CreateMetrics(sConfig.LogStrategies)
	// 注册metrics
	for _, m := range metricsMap {
		prometheus.MustRegister(m)
	}
```

## 本节重点总结

- 新建项目 log2metrics
- 编写配置文件 yaml
- main 解析配置，设置 log
- 根据配置文件设置 metrics
