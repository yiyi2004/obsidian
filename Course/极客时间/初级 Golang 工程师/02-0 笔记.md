## Gin + Gorm

## Gin

流畅的运行

技术复杂度，通用的技术主题。

- 建立 Gin 的插件库

hertz 和 Gin 的核心并没有区别，奇技淫巧，提升性能。

设计从前往后，对接的接口，同事关系和谐。

Handler 的用途

- internal 内部独有的，业务逻辑

分散注册和集中注册，路由注册和检查

**BFF 是什么**

- 大厂里面的最佳实践，不一定是最好用的。

pkg 面试中装 B 的通用的东西

### 登录

JSON 提交，前后端分离，表单用的比较少。

密码强度，二次验证登录安全 —— 短信、邮件。

但是没有以前那么重要。

不能仅仅让前端校验，但是后端必须要校验。

https 传输非常好

自己约定的加密方法

正则表达式

不要返回内部错误，要返回对外的服务，不要让别人猜出来。

### 跨域问题

- 协议
- 域名
- 端口

preflag options 方法

request header

middleware，责任链，中间件，拦截器等等名字。

gin- 中间件的库有些是有并发问题的

Aspect-Oriented Programming

中间件有并发访问的问题

触发跨域请求

![image-20240101203758639](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240101203758639.png)

我有的时候在想，你是真的不知道我的雷点在哪里嘛？

- ginx

面试

- 沉淀出了一个 gin 的插件库

![image-20240101205935046](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240101205935046.png)

- 支持的功能，登录校验。

开源的不如自研，自研的才有 API。

> 舒服的思路：推行方案有利于你的领导

### 面试题

- 什么是 Gin 的 middleware，解决什么问题？

> 1. 我直到 gin middleware
> 
> 2. 解释什么是？原理？
> 3. 案例 (高大上)，针对 IP 的限流，针对用户是否是 VIP 限流方案。
>    1. 要不同于市面上的方案

- 什么是跨域问题？
- 跨域问题需要设置那些头部？
- **研发插件库**：相当多的实现非常一般

## GORM

- 简单的很 + 密码强度的问题
- eorm 反向 orm 框架

前端展示解决时区问题，int64 格林尼治时间

DryRun = true ---> config

```go
db = db.Debug()
```

- builder 模式

### 学习难点

- gorm.Model id update time delete_time, 软删除

权限控制，通过 DBA 给你的实现。

- 标签，照着文档进行复制粘贴
- 高级的功能不推荐使用，不是 ORM 层面上的解决的问题。

> docker compose up 里面看日志信息看执行日志，找到初始化脚本的位置。

### 数据库代码放哪里？

- Handler 中负责和 HTTP 相关的操作。

长期实践 DDD

DAO —— 一个业务完整的处理流程

- service 一个业务的完整的处理流程
  - 检测邮件冲突
- repository：领域对象的存储
  - oss
  - 文件
  - es
  - cache
    - redis
  - db
  - dao: 数据库操作
    - 数据库存
- domain
  - 业务上 User 的概念
    - User Address
  - 业务上 User 的概念和数据库层面上 User 的概念是不一样的。

DDD: Domain-Driven Design

### 第三节

- 删除操作，向前拷贝 + stack[len - 1]
- slice 的扩容和缩容的算法
- CPU 和内存之间取得权衡

ekit 的方法，delete at

考虑输入的参数是分配在堆上还是分配在栈上。

性能优化

int64 更好的处理时区问题。

UTC

处理，这个做的也是可以的，但是不好呀。你们到底怎么回事啊。

User 在 DAO 里面直接对应数据库表

panic：goroutine 直接结束

**初始化过程需要使用 panic**

业务层面上的：domain.User

数据库层面上的：dao.User ---> 数据库的定义

经验：复制粘贴 gorm 标签，不然可能会打错。

UserDetail ---> 两张表

**表结构变更要走审核流程，给 DBA 看一看**

- 最常用的查询，对应的 SQL。
- 外企就是这么舒服和没有效率

垃圾设计：

![image-20240107100041675](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240107100041675.png)

快捷键：err.nn

#### 加密

- Java 注解的形式

![image-20240107100830248](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240107100830248.png)

数据怎么加密是 domain.User 需要做的，DDD

- 彩虹表

常见的加密算法

md5 + salt

PBKDF2(额外存储 salt) BCrypt(号称最安全的)

![image-20240107101412897](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240107101412897.png)

- 经验：地址的加密是需要解密出来的

#### 错误码

- 插入的时候 1062 错误码

err 类型断言

- 先查询，会有并发问题。

先查询并发问题：

> 事务 + select … for update
> 
> 没有 123@qq.com 如果是可重复读的时候加的是间隙锁，存在就是行锁。
> 
> 这么简单的问题用分布式锁。
> 
> 本地的锁是不行的。

```go
var Err = repo.Err // 可以的
```

- 全局的 errs 库，定义业务前缀。
- 不应该有跨层的设计。—— 扩展性，定义前缀不就好了。

为什么不用 errors.Is(err, xxx) ---> **最佳实践**

各种人的错误处理是怎么设计的。

所得范围，分布式锁。

#### 登录功能

1. 登录本身
2. 登录校验

最佳实践都是不一样的，google 的代码规范。

Vue + Element，我的技术栈和大家不一样啊。

告诉前端是系统问题，还是输入的问题，是输入的账号密码问题。

**错误不要太准确，账号或者密码错误。**

- DEBUG 日志 | INFO | WARNING
- 利用别名的方式处理错误信息

登录校验，登录态保存好。上号自己的课程，多关注自己。

cookie 和 session 用这个来做，就比较简单

#### Session

![image-20240107145930455](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240107145930455.png)

- session_id 一旦拿到就是很要命的事情

JWT Token

携带位置

- cookie
- header
- query

增加 session_id 的校验

- sessions.Set 之后一定要 **save**

![image-20240107154318026](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240107154318026.png)

- IgnorePath 的设计

只有一个包变量的问题

![image-20240108085034014](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240108085034014.png)

- 从来都是 Build 方法 —— 设计模式。确实是很好的设计。

option 模式，链式调用，最好使用 Builder 模式。

- builder 模式不能对用户的程序有任何的假设。

升职加薪指南：

![image-20240108085904552](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240108085904552.png)

- **技术影响力**

![image-20240108090114983](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240108090114983.png)

#### 作业

![image-20240108090157913](C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240108090157913.png)

### 作业：实现编辑功能

你需要完善 /users/edit 对应的接口。要求：

- 允许用户补充基本个人信息，包括：
  - 昵称：字符串，你需要考虑允许的长度。
  - 生日：前端输入为 1992-01-01 这种字符串。
  - 个人简介：一段文本，你需要考虑允许的长度。
- 尝试校验这些输入，并且返回准确的信息。
- 修改 /users/profile 接口，确保这些信息也能输出到前端。

不要求你开发前端页面。提交作业的时候，顺便提交 postman 响应截图。加一个 README 文件，里面贴个图。

就是补充 live 分支上的 Edit 和 Profile 接口。

PS：暂时不要求上传头像，后面我们讲到 OSS 之后直接用 OSS。

### 作业提交

- 截止时间：2023 年 8 月 13 日（周日）24:00
- 提交方法：将你作业的 Gitee 或 GitHub 地址填写到下方的“作业提交框”中，并点击提交即可（记得开权限哦，不然助教老师打不开~）

### 作业批改

- 截止时间后一周内
- 关注“极客时间训练营”公众号作业批改完成会有消息提示
