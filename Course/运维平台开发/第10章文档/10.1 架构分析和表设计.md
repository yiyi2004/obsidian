## 架构图

![.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/908/1638008974000/3228d7d09aa640edaa67ccca19ca4aca.png)

## task_meta 任务配置信息表

```sql
CREATE TABLE `task_meta`
(
    `id`        bigint unsigned NOT NULL AUTO_INCREMENT,
    `title`     varchar(255)    not null default '' COMMENT '标题',
    `account`   varchar(64)     not null COMMENT '脚本执行账号',
    `timeout`   int unsigned    not null default 0  COMMENT '执行超时',
    `hosts_raw` varchar(4096)   not null  COMMENT '执行机器的ip列表json',
    `script`    text            not null COMMENT '执行的脚本',
    `args`      varchar(512)    not null default '' COMMENT '执行的脚本的参数',
    `creator`   varchar(64)     not null default '' COMMENT '创建者',
    `created`   timestamp       not null COMMENT '创建时间',
    `done`      int unsigned    not null COMMENT '任务结束与否的标志位=0未结束，=1结束',
    PRIMARY KEY (`id`),
    KEY (`created`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;




```

## task_result 任务结果表

```sql
CREATE TABLE task_result
(
    `id`      bigint unsigned not null AUTO_INCREMENT,
    `task_id` bigint unsigned not null COMMENT '归属于哪个任务',
    `host`    varchar(128)    not null  COMMENT '哪个机器',
    `status`  varchar(32)     not null COMMENT '任务执行的结果eg:success failed ...',
    `stdout`  text COMMENT '标准输出',
    `stderr`  text COMMENT '标准错误',
    UNIQUE KEY (`task_id`, `host`),
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
```

## 在 Mysql 中新建上面两张表

- 新增 sql/job_exec.sql

## 相关的表结构翻译成 Go 结构体

### 新建 models\task_meta.go

- 完成如下表结构的翻译

```go
package models

import (
	"fmt"
	"time"
)

type TaskMeta struct {
	Id       int64           `json:"id"`
	Title    string          `json:"title"`                  // 标题
	Account  string          `json:"account"`                //脚本执行账号
	Timeout  int             `json:"timeout"`                // 执行超时
	Script   string          `json:"script"`                 //执行的脚本
	Args     string          `json:"args"`                   //执行的脚本的参数
	Creator  string          `json:"creator"`                //创建者
	Created  time.Time       `xorm:"created" json:"created"` //创建时间
	HostsRaw string `json:"hosts"`                  // 执行机器的ip列表json
	Hosts    []string        `xorm:"-" json:"-"`
	Done     int             `xorm:"done" json:"done"` //任务结束与否的标志位=0未结束，=1结束
	Clock    int64           `xorm:"-" json:"clock"`
	Action   string          `xorm:"-" json:"action"`
}
// 查询一条
func TaskMetaGet(where string, args ...interface{}) (*TaskMeta, error) {
	var obj TaskMeta
	has, err := DB["stree"].Where(where, args...).Get(&obj)
	if err != nil {
		return nil, err
	}

	if !has {
		return nil, nil
	}

	return &obj, nil
}

func TaskMetaGetUnDo() ([]*TaskMeta, error) {

	var objs []*TaskMeta
	session := DB["stree"].Where("done=0 ")
	err := session.Find(&objs)
	return objs, err

}

// 将任务标记为已完成
func MarkTaskMetaDone(id int64) error {
	session := DB["stree"].NewSession()
	defer session.Close()
	if err := session.Begin(); err != nil {
		return err
	}

	sql := fmt.Sprintf("UPDATE task_meta SET done=1  WHERE id=%d ", id)

	if _, err := session.Exec(sql); err != nil {
		session.Rollback()
		return err
	}

	return session.Commit()
}

// 插入一条记录
func (tm *TaskMeta) AddOne() (int64, error) {
	_, err := DB["stree"].InsertOne(tm)
	return tm.Id, err
}

// 查询多条
func TaskMetaGets(where string, args ...interface{}) ([]*TaskMeta, error) {
	var obj []*TaskMeta
	err := DB["stree"].Table("task_meta").Where(where, args...).Find(&obj)
	if err != nil {
		return nil, err
	}

	return obj, nil
}

```

### 新建 models\task_result.go

- 完成 task_result 的翻译

```go
package models

import "fmt"

type TaskResult struct {
	Id     int64  `json:"id"`
	TaskId int64  `json:"task_id"` //归属于哪个任务
	Host   string `json:"host"`  //哪个机器
	Status string `json:"status"` //任务执行的结果eg:success failed ...
	Stdout string `json:"stdout"` //标准输出
	Stderr string `json:"stderr"` // 标准错误
}

func (ts *TaskResult) Save() (error, bool) {
	var obj TaskResult
	sql := fmt.Sprintf(" task_id=%d and host='%s' ", ts.TaskId, ts.Host)
	has, err := DB["stree"].Where(sql).Get(&obj)
	if err != nil {
		return err, false
	}
	if has {
		return nil, false
	}
	_, err = DB["stree"].Insert(ts)
	return nil, true
}

```
