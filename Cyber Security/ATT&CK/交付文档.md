## 服务器环境部署

服务器需要一台 Ubuntu20.04 系统的主机，Java 中间件、威胁关联和项目前端等服务均部署在该服务器上，服务器的账号密码如下：

```
user: root
password: rongyi

user: rongyi
password: rongyi
```

### 软件部署

服务端口说明：

1. 威胁库后端：8000
2. 威胁关联 Python 后端：8001
3. Java 中间件默认端口：8081
4. 威胁库前端：8082
5. 项目前端：8083

获取数据库数据和威胁关联模块采用不同语言编写，通过 RESTful API 进行数据交互。

#### HIDS

##### HIDS 安装

HIDS 安装命令

```shell
curl -sO https://packages.wazuh.com/4.4/wazuh-install.sh && sudo bash ./wazuh-install.sh -a
```

HIDS 卸载命令

```shell
curl -sO https://packages.wazuh.com/4.4/wazuh-install.sh && sudo bash ./wazuh-install.sh -u
```

##### 获取 HIDS 密钥

登录威胁检测服务器 (虚拟机)

```shell
ssh root@192.168.2.171 -p 10514
```

上面的 ssh 密码是 `password`

```shell
sudo tar -O -xvf wazuh-install-files.tar wazuh-install-files/wazuh-passwords.txt
```

输入上诉命令会返回一系列密钥，如下：

```
# Admin user for the web user interface and Wazuh indexer. Use this user to log in to Wazuh dashboard
  indexer_username: 'admin'
  indexer_password: '?XoY.2y9zepB36zYlJBbqEX2xeNV6yPo'

# Wazuh dashboard user for establishing the connection with Wazuh indexer
  indexer_username: 'kibanaserver'
  indexer_password: 'lVK9HKoOXMgYrRW0lJgz1+y?GcL44etr'

# Regular Dashboard user, only has read permissions to all indices and all permissions on the .kibana index
  indexer_username: 'kibanaro'
  indexer_password: 'KYrF+YeSOEAzxBqmq7DCOn9lfR7R?4wa'

# Filebeat user for CRUD operations on Wazuh indices
  indexer_username: 'logstash'
  indexer_password: '1vFp+Ddt4EtihheG+ZISWrajJLVr?Uux'

# User with READ access to all indices
  indexer_username: 'readall'
  indexer_password: '8zJo*+nOcl?*sxQ17kktV.QEzTjmfWN7'

# User with permissions to perform snapshot and restore operations
  indexer_username: 'snapshotrestore'
  indexer_password: 'CRAIr3oXhgppR6q2LDa9Xudh2Q4v?XP*'

# Password for wazuh API user
  api_username: 'wazuh'
  api_password: 'scFChT030H6D2SRtlkWmYf*?ou*AwoJ6'

# Password for wazuh-wui API user
  api_username: 'wazuh-wui'
  api_password: '3nx09fOBHXWpOmW*4gQHXa49lR?F?GSL'
```

其中 `User with READ access to all indices` 和 `Password for wazuh API user` 是对我们有用的，需要写到 Java 后端的配置文件中。

##### 配置 Agent

Ubuntu 系统部署 Agent 需要运行以下命令：

```shell
curl -so wazuh-agent.deb https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.4.0-1_amd64.deb && sudo WAZUH_MANAGER='192.168.2.171' WAZUH_AGENT_GROUP='default' WAZUH_AGENT_NAME='agent_name' dpkg -i ./wazuh-agent.deb
```

其中 `WAZUH_MANAGER` 指的是威胁检测服务器的 IP，`WAZUH_AGENT_NAME` 指的是 Agent 的名字，如有必要可以替换。

然后执行：

```shell
sudo systemctl daemon-reload 
sudo systemctl enable wazuh-agent 
sudo systemctl start wazuh-agent
```

如果 Agent 没有部署成功，请尝试更改 `WAZUH_AGENT_NAME` 因为可能是因为 Agent 的名称冲突导致。

##### 配置 Audit

#### NIDS

##### NIDS 安装

##### NIDS 配置

#### 后端环境

所有编译后代码存储在云服务器的 `/prepare` 路径下

##### Java 中间件部署

编写配置文件 'application.json'：

```
server:
  port: 8081

spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    url: jdbc:mysql://localhost:3306/attack_detection?serverTime=UTC
    username: root
    password: 123456

mybatis:
  mapper-locations: classpath:mapper/*xml
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

wazuh:
  token:
    command: "curl -u wazuh:scFChT030H6D2SRtlkWmYf*?ou*AwoJ6 -k -X GET \"https://localhost:55000/security/user/authenticate?raw=true\""
  server:
    base-url:  https://localhost:55000
  indexer:
    username: readall
    password: 8zJo*+nOcl?*sxQ17kktV.QEzTjmfWN7
    base_url: https://localhost:9200/wazuh-alerts-4.x-*/_search
    count_url: https://localhost:9200/wazuh-alerts-4.x-*/_count
```

如果是重新部署的环境，需要修改的配置文件有两处：

1. 需要修改 `wazuh.token.command` 中 `wazuh:scFChT030H6D2SRtlkWmYf*?ou*AwoJ6` 中 `:` 后面的部分修改为用户 `wazuh` 对应的密钥 (详见 HIDS 安装)
2. 需要修改 `wazuh.indexer.password` 修改成用户 `readall` 的新的密钥。

后台运行 Java 服务的命令：

```shell
nohup java -jar AttackDetection-1.0-SNAPSHOT.jar > attack_detection.log 2>&1 &
```

其中 `attack_detection.log` 是日志输出，当然您也可以重定向到其他位置，便于统一化管理。

停止 Java 服务方法：

```shell
ps -ef | grep java
# 找到对应的进程
kill -9 <process_id>
```

##### 威胁库后端部署

```shell
pip install -r requirements.txt
python3 manage.py runserver 0.0.0.0:8000
```

##### 威胁关联服务部署

在部署之前需要修改配置文件 'server_config.json' 中的 'server_ip' 修改为服务器的 IP

```
pip install -r requirements.txt
python3 MyServer.py
```

#### 前端环境

##### Nginx 部署

部署 Nginx 是为了部署我们的前端代码，其中有些地方需要修改 IP，这些 IP 取决于服务器的 IP，将会在后面统一说明。

```shell
sudo apt update
sudo apt install nginx
sudo systemctl status nginx

sudo ufw allow 'Nginx Full'
sudo ufw status
```

`/etc/nginx/nginx.conf` 如下：

```
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768;
    # multi_accept on;
}

http {
	# 威胁库前端配置
    server {
        listen       8082;
        server_name  attlibVue;
        location / {
            root   /prepare/ATT_Threat_Library/VueWeb/dist/;
            index  index.html;
        }
        error_page 500 502 503 504  /50x.html;
    }

	# 项目前端配置
    server {
        listen       8083;
        server_name  attDetectionVue;
        location /pyapi {
	        # 192.168.2.171 是服务器 IP
            proxy_pass http://192.168.2.171:8001/pyapi;
        }
        
        location / {
            root /prepare/deploy_changeip/dist/;
            index index.html;
        }

        error_page 500 502 503 504  /50x.html;#错误页面
    }

    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    # server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings
    ##

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
    ssl_prefer_server_ciphers on;

    ##
    # Logging Settings
    ##
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Gzip Settings
    ##
    
    gzip on;
    
    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

##### 威胁库前端部署

需要修改‘project_path/src/api/api.js’ 中变量 'ipport' 中 IP 的部分为服务器的 IP。然后执行：

```
npm install
npm run build 
```

然后将打包好的 `dist` 放到 Nginx 配置文件中对应的文件夹中，当然您也可以修改 Nginx 配置文件，将前端代码部署到您希望的位置。

##### 项目前端部署

需要修改 'project_path/public/server.json' 中的 'server_ip' 为服务器 IP。然后执行：

```
npm install
npm run build
```

然后将打包好的 `dist` 放到 Nginx 配置文件中对应的文件夹中，当然您也可以修改 Nginx 配置文件，将前端代码部署到您希望的位置。

## 模拟攻击
